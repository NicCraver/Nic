<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Vue 页面导出 PDF 与 html2canvas 跨域问题 | Nic | Y</title>
    <meta name="description" content="I am Nic, Work hard and love life, but more importantly, love 越.">
    <link rel="icon" href="/yy.ico">
    
    <link rel="preload" href="/assets/css/0.styles.8832d794.css" as="style"><link rel="preload" href="/assets/js/app.a812c260.js" as="script"><link rel="preload" href="/assets/js/20.bc4fe4ef.js" as="script"><link rel="prefetch" href="/assets/js/10.8c6ff936.js"><link rel="prefetch" href="/assets/js/11.1b0164cf.js"><link rel="prefetch" href="/assets/js/12.dfe8f7db.js"><link rel="prefetch" href="/assets/js/13.e2a98b81.js"><link rel="prefetch" href="/assets/js/14.304c37db.js"><link rel="prefetch" href="/assets/js/15.4c9987aa.js"><link rel="prefetch" href="/assets/js/16.bda155f4.js"><link rel="prefetch" href="/assets/js/17.511ec22f.js"><link rel="prefetch" href="/assets/js/18.31067e99.js"><link rel="prefetch" href="/assets/js/19.91facd4a.js"><link rel="prefetch" href="/assets/js/2.3073d43b.js"><link rel="prefetch" href="/assets/js/21.36d20b92.js"><link rel="prefetch" href="/assets/js/22.329bc2e9.js"><link rel="prefetch" href="/assets/js/23.eaa9cc84.js"><link rel="prefetch" href="/assets/js/24.29e35af5.js"><link rel="prefetch" href="/assets/js/25.b8376c98.js"><link rel="prefetch" href="/assets/js/3.192a24fc.js"><link rel="prefetch" href="/assets/js/4.cdc33260.js"><link rel="prefetch" href="/assets/js/5.30c86042.js"><link rel="prefetch" href="/assets/js/6.1ae9f685.js"><link rel="prefetch" href="/assets/js/7.7c4a7185.js"><link rel="prefetch" href="/assets/js/8.efd41c53.js"><link rel="prefetch" href="/assets/js/9.041d5bf1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8832d794.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><section id="global-layout" data-v-4447dda2><header class="header" data-v-1f858c5b data-v-4447dda2><div class="header-navbar" data-v-1f858c5b><div class="flex-xbc main header-nav" data-v-1f858c5b><div class="nav-link" data-v-1f858c5b><a href="/" class="inblock link-logo router-link-active" data-v-1f858c5b><img data-src="/logo.png" loading="lazy" alt="logo" class="logo-img lazy" data-v-1f858c5b></a> <nav class="link-list" data-v-1f858c5b><a href="/" class="list-item router-link-active" data-v-1f858c5b>主页</a><a href="/posts/" class="list-item router-link-active" data-v-1f858c5b>笔记</a><a href="/doc/" class="list-item" data-v-1f858c5b>文章</a><a href="/tag/" class="list-item" data-v-1f858c5b>标签</a><a href="/category/" class="list-item" data-v-1f858c5b>类别</a><a href="/about/" class="list-item" data-v-1f858c5b>关于</a></nav></div> <div class="search-box" data-v-1f858c5b><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div> </header> <!----> <section class="page" data-v-4447dda2><section class="info no-bg" data-v-39edd49c><article class="main info-content" data-v-f5f72dc4 data-v-39edd49c><div class="content-header" data-v-f5f72dc4><h1 class="header-title" data-v-f5f72dc4>基于 Vue 页面导出 PDF 与 html2canvas 跨域问题</h1></div> <div class="flex-wcc content-tag" data-v-f5f72dc4><div class="inblock tag-list" data-v-f5f72dc4><a href="/category/文章/" class="tag-text" data-v-f5f72dc4>文章
      </a></div> <span class="tag-space" data-v-f5f72dc4>/</span> <div class="inblock tag-list" data-v-f5f72dc4><a href="/tag/display/" class="tag-text" data-v-f5f72dc4>display
      </a><a href="/tag/test/" class="tag-text" data-v-f5f72dc4>test
      </a></div></div> <div class="content content__default" data-v-f5f72dc4><blockquote><p>基于 Vue 页面导出 PDF 与 html2canvas 跨域问题</p></blockquote> <h2 id="首先引入两个模块"><a href="#首先引入两个模块" class="header-anchor">#</a> 首先引入两个模块</h2> <div class="language-sh extra-class"><pre class="language-sh"><code>//将页面html转换成图片
<span class="token function">yarn</span> <span class="token function">add</span> html2canvas -s
//将图片生成pdf
<span class="token function">yarn</span> <span class="token function">add</span> jspdf -s
</code></pre></div><h2 id="template-代码"><a href="#template-代码" class="header-anchor">#</a> template 代码</h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>pdf<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  内容
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">:src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>imgUrl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>el-icon-download<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ExportPdf<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:loading</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ExportPdfloading<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>导出PDF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span>
<span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <p>::: tip 原理</p> <ol><li>通过 html2Canvas 将 html 中指定区域转化为 canvas <br></li> <li>使用 canvas.toDataURL(&quot;image/jpeg&quot;, 1.0);将 canvas 转为 base64 <br></li> <li>再通过 jspdf 导出 pdf</li></ol> <p>:::</p> <h2 id="js-代码"><a href="#js-代码" class="header-anchor">#</a> js 代码</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> html2Canvas <span class="token keyword">from</span> <span class="token string">&quot;html2canvas&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> JsPDF <span class="token keyword">from</span> <span class="token string">&quot;jspdf&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&quot;pdf&quot;</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      ExportPdfloading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      imgUrl<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">ExportPdf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">html2Canvas</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#pdf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        allowTaint<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        dpi<span class="token punctuation">:</span> <span class="token number">400</span> <span class="token comment">//据说是清晰度，改了也看不出啥变化</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> contentWidth <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">let</span> contentHeight <span class="token operator">=</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
        <span class="token comment">// A4纸宽度 592.28</span>
        <span class="token keyword">let</span> pageHeight <span class="token operator">=</span> <span class="token punctuation">(</span>contentWidth <span class="token operator">/</span> <span class="token number">592.28</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">841.89</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> leftHeight <span class="token operator">=</span> contentHeight<span class="token punctuation">;</span>
        <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> imgWidth <span class="token operator">=</span> <span class="token number">592.28</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> imgHeight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">592.28</span> <span class="token operator">/</span> contentWidth<span class="token punctuation">)</span> <span class="token operator">*</span> contentHeight<span class="token punctuation">;</span>
        <span class="token keyword">let</span> pageData <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//最后将canvas转换成base64  1.0是转换成base64的清晰度</span>
        <span class="token keyword">let</span> <span class="token constant">PDF</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsPDF</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leftHeight <span class="token operator">&lt;</span> pageHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token constant">PDF</span><span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>pageData<span class="token punctuation">,</span> <span class="token string">&quot;JPEG&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>leftHeight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">PDF</span><span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>pageData<span class="token punctuation">,</span> <span class="token string">&quot;JPEG&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> position<span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            leftHeight <span class="token operator">-=</span> pageHeight<span class="token punctuation">;</span>
            position <span class="token operator">-=</span> <span class="token number">841.89</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leftHeight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token constant">PDF</span><span class="token punctuation">.</span><span class="token function">addPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 浏览器自动下载pdf文件</span>
        <span class="token constant">PDF</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">&quot;pdf.pdf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="使用-html2canvas-无法渲染网络图片"><a href="#使用-html2canvas-无法渲染网络图片" class="header-anchor">#</a> 使用 html2canvas 无法渲染网络图片</h2> <p>::: danger 注意</p> <ol><li>服务器的图片，必须是已经设置了允许跨域的</li> <li>如果服务器端的图片不允许跨域访问，使用一下方法也无法解决</li></ol> <p>:::</p> <h2 id="解决思路"><a href="#解决思路" class="header-anchor">#</a> 解决思路</h2> <p>::: tip</p> <ol><li>将网络图片转为 base64，在页面中使用 base64 渲染</li> <li>通过 html2Canvas 将 html 中指定区域转化为 canvas</li> <li>使用 canvas.toDataURL(&quot;image/jpeg&quot;, 1.0);将 canvas 转为 base64</li> <li>再通过 jspdf 导出 pdf</li></ol> <p>:::</p> <h2 id="js-代码-2"><a href="#js-代码-2" class="header-anchor">#</a> js 代码</h2> <p>首先定义一个方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">getBase64</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> ext<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建canvas DOM元素</span>
    <span class="token keyword">var</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>crossOrigin <span class="token operator">=</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">;</span><span class="token comment">//说是可以跨域，但还是要看服务端是否允许跨域</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
    img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> img<span class="token punctuation">.</span>width<span class="token punctuation">;</span> <span class="token comment">//指定画板的宽度，自定义</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> img<span class="token punctuation">.</span>height<span class="token punctuation">;</span> <span class="token comment">//指定画板的高度,自定义</span>
    ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>width<span class="token punctuation">,</span> img<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//参数可自定义</span>
    <span class="token keyword">var</span> dataURL <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">&quot;image/&quot;</span> <span class="token operator">+</span> ext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dataURL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//回掉函数获取Base64编码</span>
    canvas <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> temp <span class="token operator">=</span>
  <span class="token string">&quot;https://images.unsplash.com/photo-1488590528505-98d2b5aba04b?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=1350&amp;q=80&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBase64</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">,</span> <span class="token string">&quot;png&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">base64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 给原生img对象的src属性赋值</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>imgUrl <span class="token operator">=</span> base64<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="在通过上面exportpdf-方法导出-pdf"><a href="#在通过上面exportpdf-方法导出-pdf" class="header-anchor">#</a> 在通过上面<code>ExportPdf()</code>方法导出 PDF</h3></div> <div class="content-time" data-v-f5f72dc4><time datetime="2019-02-22" class="time-text" data-v-f5f72dc4>Create Time: 2019-2-20</time> <time datetime="2019-02-22" class="time-text" data-v-f5f72dc4>Last Updated: 2019-11-13</time></div></article> <section class="flex-xb main info-nav" data-v-71a7ec73 data-v-39edd49c><a href="/posts/listening-page.html" class="flex-xb nav-item" data-v-71a7ec73><div class="flex-xcc item-img" data-v-71a7ec73><img data-src="https://picsum.photos/1920/1080/?random&amp;date=2019-02-20-42" alt="监听页面时刷新还是离开" loading="lazy" class="img lazy" data-v-71a7ec73></div> <article class="flex-ysc item-content" data-v-71a7ec73><h2 class="content-title" data-v-71a7ec73>监听页面时刷新还是离开</h2> <div class="content" data-v-71a7ec73></div></article></a> <!----></section> <!----></section></section> <footer class="footer" data-v-97f32788 data-v-4447dda2><nav class="link-list" data-v-97f32788><a href="https://github.com/NicCraver" target="_blank" rel="noopener noreferrer" class="list-item" data-v-97f32788>Github</a></nav> <a href="/" class="copyright router-link-active" data-v-97f32788>Nic | Y © 2019</a></footer></section><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a812c260.js" defer></script><script src="/assets/js/20.bc4fe4ef.js" defer></script>
  </body>
</html>
